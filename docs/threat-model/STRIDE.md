# Анализ угроз STRIDE — API Workout Log

## Обзор
Документ содержит анализ угроз по модели STRIDE (Подделка, Изменение, Отказ, Утечка информации, Отказ в обслуживании, Повышение привилегий) для API Workout Log, сфокусированный на ключевых потоках данных, определённых в DFD.

---

## Ключевые потоки данных

### F10: POST /auth/login (Процесс аутентификации)
**Поток**: Пользователь → Браузер → API → Auth → UserDB

#### S - Подделка (Spoofing)
**Угроза**: Атакующий подменяет учетные данные легитимного пользователя
- **Контроль**: Сильное хеширование паролей (Argon2), ограничение частоты попыток входа
- **Ссылка на NFR (P03)**: NFR-01 (Безопасность аутентификации)
- **Проверка**:
  - Тест: `test_invalid_credentials_login()` в `tests/test_auth.py`
  - Реализация: Хеширование паролей через `src/services/auth.py`

#### T - Изменение (Tampering)
**Угроза**: Атакующий изменяет запрос на вход
- **Контроль**: Валидация входных данных, безопасное генерирование токенов с HMAC
- **Ссылка на NFR (P03)**: NFR-02 (Целостность данных)
- **Проверка**:
  - Тест: `test_email_validation()` в `tests/test_auth.py`
  - Реализация: Валидация через Pydantic в `src/domain/schemas.py`

---

### F18: POST /api/v1/workouts + Bearer Token (Создание тренировки)
**Поток**: Пользователь → Браузер → API → Auth → WorkoutSvc → WorkoutDB

#### I - Утечка информации (Information Disclosure)
**Угроза**: Чувствительные данные тренировки раскрыты из-за недостаточной авторизации
- **Контроль**: Ограничение доступа по владельцу, проверка JWT
- **Ссылка на NFR (P03)**: NFR-03 (Авторизация и контроль доступа)
- **Проверка**:
  - Тест: `test_get_another_user_workout()` в `tests/test_workouts.py`
  - Реализация: Фильтрация по `user_id` в `src/services/workouts.py`

#### E - Повышение привилегий (Elevation of Privilege)
**Угроза**: Пользователь получает доступ к чужим тренировкам (IDOR)
- **Контроль**: Строгая фильтрация по `user_id` в запросах
- **Ссылка на NFR (P03)**: NFR-03 (Авторизация и контроль доступа)
- **Проверка**:
  - Тест: `test_update_another_user_workout()` в `tests/test_workouts.py`
  - Реализация: Функция `ensure_owner()` в сервисах

---

### F29: GET /api/v1/workouts/{id} + Bearer Token (Получение тренировки)
**Поток**: Пользователь → Браузер → API → Auth → WorkoutSvc → WorkoutDB

#### S - Подделка (Spoofing)
**Угроза**: Атакующий использует украденный JWT-токен для доступа к данным
- **Контроль**: Короткая экспирация токена (15 минут), безопасное хранение токенов
- **Ссылка на NFR (P03)**: NFR-01 (Безопасность аутентификации)
- **Проверка**:
  - Тест: `test_unauthorized_access()` в `tests/test_workouts.py`
  - Реализация: Валидация JWT в `src/app/dependencies/auth.py`

#### I - Утечка информации (Information Disclosure)
**Угроза**: Данные тренировки выдаются из-за недостаточных контролей
- **Контроль**: Фильтрация по `user_id`, отсутствие утечки в сообщениях об ошибках
- **Ссылка на NFR (P03)**: NFR-04 (Конфиденциальность данных)
- **Проверка**:
  - Тест: `test_get_another_user_workout()` возвращает 404, не 403
  - Реализация: Фильтрация по `user_id` в `get_workout()`

---

### F39: POST /api/v1/exercises + Bearer Token (Создание упражнения)
**Поток**: Пользователь → Браузер → API → Auth → ExerciseSvc → ExerciseDB

#### T - Изменение (Tampering)
**Угроза**: Злонамеренные данные упражнений влияют на других пользователей
- **Контроль**: Валидация входных данных, ограниченные имена упражнений
- **Ссылка на NFR (P03)**: NFR-02 (Целостность данных)
- **Проверка**:
  - Тест: `test_exercise_validation_long_name()` в `tests/test_exercises.py`
  - Реализация: Ограничение длины имени через Pydantic

#### R - Отказ (Repudiation)
**Угроза**: Пользователь отрицает создание вредоносного упражнения
- **Контроль**: Аудит-логи, атрибуция пользователя
- **Ссылка на NFR (P03)**: NFR-05 (Аудит и логирование)
- **Проверка**:
  - Реализация: `user_id` сохраняется в каждой записи
  - База данных: Foreign key `user_id` в таблице exercises

---

### F49: GET /api/v1/stats + Bearer Token (Статистика)
**Поток**: Пользователь → Браузер → API → Auth → StatsSvc → WorkoutDB

#### I - Утечка информации (Information Disclosure)
**Угроза**: Статистика раскрывает чувствительные паттерны пользователей
- **Контроль**: Ограничение доступа по пользователю, нет перекрестного анализа
- **Ссылка на NFR (P03)**: NFR-04 (Конфиденциальность данных)
- **Проверка**:
  - Тест: `test_stats_user_isolation()` в `tests/test_stats.py`
  - Реализация: Фильтрация по `user_id` в запросах

#### D - Отказ в обслуживании (Denial of Service)
**Угроза**: Сложные запросы агрегации перегружают систему
- **Контроль**: Оптимизация запросов, ограничение пагинации
- **Ссылка на NFR (P03)**: NFR-06 (Производительность и масштабируемость)
- **Проверка**:
  - Реализация: Эффективные SQL-запросы с индексами
  - База данных: Индексы на полях `user_id` и `workout_id`

---

### F60: GET /api/v1/exercises/admin/all + Bearer Token (Доступ администратора)
**Поток**: Админ → Браузер → API → Auth → ExerciseSvc → ExerciseDB

#### E - Повышение привилегий (Elevation of Privilege)
**Угроза**: Обычный пользователь получает права администратора
- **Контроль**: Ролевой контроль доступа, валидация токена админа
- **Ссылка на NFR (P03)**: NFR-03 (Авторизация и контроль доступа)
- **Проверка**:
  - Тест: Админ-эндпоинты требуют `require_admin()` зависимость
  - Реализация: Проверка роли в `src/app/dependencies/auth.py`

#### I - Утечка информации (Information Disclosure)
**Угроза**: Админский доступ раскрывает все данные пользователей
- **Контроль**: Только чтение, аудит действий администратора
- **Ссылка на NFR (P03)**: NFR-04 (Конфиденциальность данных)
- **Проверка**:
  - Реализация: Админ может только читать, не изменять данные
  - База данных: Нет прав на запись у администратора в приложении

---

### F4: Хеширование пароля (UserDB)
**Поток**: Auth → UserDB

#### T - Изменение (Tampering)
**Угроза**: Хеши паролей изменены в базе данных
- **Контроль**: Целостность базы данных, ограничения доступа
- **Ссылка на NFR (P03)**: NFR-02 (Целостность данных)
- **Проверка**:
  - Реализация: Ограничения доступа к базе данных, внешние ключи
  - Безопасность: Зашифрованное соединение

#### I - Утечка информации (Information Disclosure)
**Угроза**: Хеши паролей раскрыты при компрометации базы
- **Контроль**: Сильное хеширование (Argon2), использование солей
- **Ссылка на NFR (P03)**: NFR-04 (Конфиденциальность данных)
- **Проверка**:
  - Реализация: Argon2 с автоматическим солем
  - Тест: Тесты проверки паролей в `tests/test_auth.py`

---

### F14: Генерация JWT-токена (Auth → API)
**Поток**: Auth → API

#### S - Подделка (Spoofing)
**Угр
