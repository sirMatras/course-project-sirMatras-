# Политика waivers для уязвимостей, найденных с помощью SBOM/SCA (P09)
#
# Структура опирается на курс/документ project/69_sbom-vuln-mgmt.md:
# - waivers используются осознанно и по минимуму;
# - у каждого waiver есть владелец, обоснование и срок пересмотра;
# - по возможности вместо waiver делается реальный фикс (обновление зависимости, правка кода).
#
# ============================================================================
# ОБЩАЯ ПОЛИТИКА ПО SEVERITY
# ============================================================================
#
# CRITICAL:
#   - Waiver НЕ допускается без исключительных обстоятельств
#   - Требуется: обоснование от CISO/security lead, approval от tech lead, срок пересмотра не более 30 дней
#   - Обязательна ссылка на Issue с планом миграции
#
# HIGH:
#   - Waiver допускается только с понятным обоснованием
#   - Требуется: владелец (security champion или tech lead), ссылка на Issue/PR, срок пересмотра не более 90 дней
#   - Предпочтительно: временный waiver с планом фикса в ближайшем релизе
#
# MEDIUM:
#   - Могут временно игнорироваться, если влияние минимально и обновление рискованно/дорого
#   - Требуется: владелец, обоснование, срок пересмотра не более 180 дней
#   - Рекомендуется: включить в backlog для планового обновления
#
# LOW/NEGLIGIBLE:
#   - Могут игнорироваться с минимальным обоснованием
#   - Требуется: владелец, срок пересмотра не более 365 дней
#   - Обычно обрабатываются при плановых обновлениях зависимостей
#
# Transient deps (глубокие зависимости):
#   - Предпочтительно обновить корневой пакет/образ, а не навешивать waiver
#   - Если waiver необходим, должен быть на корневой зависимости, а не на transient
#
# ============================================================================
# СТРУКТУРА WAIVER
# ============================================================================
#
# Обязательные поля:
#   - id: CVE-YYYY-XXXX (или GHSA-XXXX-XXXX для GitHub Advisory)
#   - package: имя пакета (pkg:pypi/name или pkg:npm/name и т.д.)
#   - current_version: текущая версия пакета
#   - severity: CRITICAL | HIGH | MEDIUM | LOW | NEGLIGIBLE
#   - reason: обоснование waiver (минимум 2-3 предложения)
#   - owner: GitHub login или команда (например, @security-team)
#   - issue: ссылка на Issue/PR с планом действий
#   - review_until: дата пересмотра в формате YYYY-MM-DD
#
# Опциональные поля:
#   - fixed_in_version: версия, в которой уязвимость исправлена (если известна)
#   - mitigation: описание компенсирующих мер (WAF, network isolation, etc.)
#   - affected_components: список компонентов, где используется пакет
#   - notes: дополнительный контекст, ссылки на документацию, альтернативы
#   - approved_by: кто одобрил waiver (для HIGH/CRITICAL)
#   - created_at: дата создания waiver (YYYY-MM-DD)
#
# ============================================================================
# ПРОЦЕСС РАБОТЫ С WAIVERS
# ============================================================================
#
# 1. Обнаружение уязвимости:
#    - SCA-сканер (Grype) находит уязвимость в зависимостях
#    - Результаты сохраняются в EVIDENCE/P09/sca_report.json
#
# 2. Оценка:
#    - Проверить, есть ли обновление пакета без уязвимости
#    - Оценить влияние на приложение (достижимость кода, поверхность атаки)
#    - Проверить наличие компенсирующих мер
#
# 3. Решение:
#    - Если нельзя обновить → создать Issue с планом миграции
#    - Если можно обновить → обновить зависимость и закрыть
#    - Если временно принимаем риск → оформить waiver в этом файле
#
# 4. Пересмотр:
#    - Перед истечением review_until проверить, можно ли убрать waiver
#    - Обновить зависимости или продлить waiver с новым обоснованием
#
# ============================================================================
# ПРИМЕРЫ WAIVERS
# ============================================================================

waivers:
  # Пример 1: HIGH severity - временный waiver с планом обновления
  - id: CVE-2024-56789
    package: sqlalchemy
    current_version: "2.0.36"
    severity: HIGH
    reason: >
      Уязвимость CVE-2024-56789 в SQLAlchemy 2.0.36 связана с connection pooling
      и может привести к information disclosure. Однако:
      1) Уязвимость требует доступа к внутренней сети БД, которая изолирована
         через private network и не экспонируется наружу
      2) Обновление до 2.0.37+ требует тестирования совместимости с текущей схемой БД
      3) Планируется обновление в рамках следующего релиза (Q1 2025)
      Компенсирующие меры: network isolation, database firewall rules, monitoring
    owner: @backend-team
    issue: "https://github.com/org/repo/issues/123"
    review_until: "2025-04-30"
    fixed_in_version: "2.0.37"
    mitigation: >
      - Database находится в изолированной private network
      - Применены firewall rules, ограничивающие доступ только с application servers
      - Настроен monitoring подозрительной активности на уровне БД
    affected_components:
      - "src/app/dependencies/db.py"
      - "Database connection layer"
    notes: >
      При обновлении до 2.0.37+ необходимо протестировать:
      - Миграции Alembic
      - Connection pooling behavior
      - Performance под нагрузкой
    created_at: "2025-01-15"
    approved_by: "@tech-lead"

  # Пример 2: MEDIUM severity - waiver для timing attack в JWT
  - id: CVE-2024-12345
    package: python-jose
    current_version: "3.3.0"
    severity: MEDIUM
    reason: >
      Уязвимость CVE-2024-12345 представляет собой timing attack в JWT verification.
      Риск ограничен, так как:
      1) Атака требует множественных запросов и анализа времени ответа
      2) В production используется rate limiting (100 req/min per IP)
      3) JWT tokens имеют короткое время жизни (15 минут)
      4) Обновление python-jose до версии с фиксом требует обновления зависимостей
        (cryptography, pyjwt), что запланировано на следующий квартал
    owner: @security-champion
    issue: "https://github.com/org/repo/issues/124"
    review_until: "2025-07-31"
    fixed_in_version: "3.3.1"
    mitigation: >
      - Rate limiting: 100 requests/minute per IP address
      - JWT tokens имеют TTL 15 минут
      - Monitoring аномальной активности (множественные failed auth attempts)
    affected_components:
      - "Authentication middleware"
      - "JWT token verification"
    notes: >
      При обновлении до 3.3.1+ проверить совместимость с текущими JWT tokens
      и убедиться, что не требуется миграция существующих токенов.
    created_at: "2025-01-15"

  # Пример 3: LOW severity - информационная уязвимость
  - id: CVE-2024-23456
    package: httpx
    current_version: "0.27.2"
    severity: LOW
    reason: >
      Уязвимость CVE-2024-23456 в httpx 0.27.2 связана с information disclosure
      в error messages. Риск минимален:
      1) Error messages логируются только в development/staging окружениях
      2) В production ошибки логируются без sensitive данных
      3) Обновление запланировано в рамках следующего планового обновления зависимостей
    owner: @backend-team
    issue: "https://github.com/org/repo/issues/125"
    review_until: "2025-12-31"
    fixed_in_version: "0.28.0"
    affected_components:
      - "HTTP client layer"
      - "External API integrations"
    notes: >
      Обновление до 0.28.0+ включено в backlog Q2 2025.
      Не требует срочных действий из-за низкой severity и ограниченного влияния.
    created_at: "2025-01-15"

  # Пример 4: Демонстрационный waiver для документации (можно удалить)
  - id: CVE-2023-99999
    package: example-lib
    current_version: "0.1.0"
    severity: MEDIUM
    reason: >
      Демонстрационный waiver для P09: уязвимость относится к редко используемой
      CLI-функциональности example-lib, которая не экспонируется в API сервиса.
      Обновление до 0.2.x требует мажорных изменений зависимостей, поэтому переносим фикс
      на последующий технический релиз.
    owner: security-champion
    issue: "https://github.com/org/repo/issues/999"
    review_until: "2026-12-31"
    notes: >
      При первом же плановом обновлении зависимостей нужно попытаться убрать waiver
      и перейти на версию без уязвимости.

# ============================================================================
# ВАЛИДАЦИЯ
# ============================================================================
#
# Этот файл должен проходить валидацию:
# - Все обязательные поля присутствуют
# - review_until в будущем (не прошедшая дата)
# - severity соответствует политике
# - issue ссылается на существующий Issue/PR
#
# Рекомендуется использовать CI-проверку для валидации структуры YAML
# и проверки, что review_until не истёк.
